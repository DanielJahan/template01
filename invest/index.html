<!DOCTYPE HTML>
<html>
  <head>
    <title>Invest — Million Stars Resort</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <!-- Keep the same base so your asset paths work the same as index.html -->
    <base href="/template01/">

    <!-- Same CSS as the homepage -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
  </head>

  <body class="is-preload">
    <div id="page-wrapper">

      <!-- Simple header with a Home link back to the landing page -->
      <header id="header">
        <h1 id="logo"><a href="/">Million Star Resort</a></h1>
        <nav id="nav">
          <ul>
            <li><a href="/">Home</a></li>
          </ul>
        </nav>
      </header>

      <!-- Invest-only content -->
      <section id="invest-form" class="wrapper style1 special fade">
        <div class="container">
          <div class="box">
            <header class="major">
              <h2>Invest in Million Star Resort</h2>
              <p>Connect your wallet and contribute in MATIC on Polygon.</p>
            </header>

            <form id="investForm" class="cta">
              <div class="row gtr-uniform gtr-50">

                <!-- Select Wallet (informational; MetaMask is detected automatically) -->
                <div class="col-12">
                  <label for="walletSelect"><strong>Select Wallet</strong></label>
                  <select id="walletSelect" class="fit">
                    <option value="">Choose a wallet…</option>
                    <option value="metamask">MetaMask</option>
                    <option value="trust">TrustWallet</option>
                  </select>
                </div>

                <!-- Amount -->
                <div class="col-12">
                  <label for="amountMatic" style="margin-top:0.75rem;"><strong>Amount (MATIC)</strong></label>
                  <input id="amountMatic" type="number" class="fit" min="0" step="0.0001" placeholder="e.g. 1.0">
                </div>

                <!-- Actions -->
                <div class="col-12">
                  <ul class="actions" style="margin-top:1rem;">
                    <li><a id="btnConnect" class="button">Connect Wallet</a></li>
                    <li><a id="btnInvest" class="button primary">Invest</a></li>
                  </ul>
                </div>

                <!-- Status -->
                <div class="col-12">
                  <pre id="investStatus" style="white-space:pre-wrap; background:#0b1633; color:#fff; padding:6px 8px; border-radius:6px;">
Status: Not connected
                  </pre>
                </div>

                <!-- Contract Address (read-only) -->
                <div class="col-12">
                  <label for="contractAddress" style="margin-top:0.75rem;"><strong>Contract Address</strong></label>
                  <input id="contractAddress" type="text" class="fit" value="0x6715A25da511a4909dFBFbAD906Aa41F444CfD7a" readonly>
                </div>

                <!-- Referral (optional) -->
                <div class="col-12">
                  <label for="referralAddr" style="margin-top:0.75rem;"><strong>Referral Address (optional)</strong></label>
                  <input id="referralAddr" type="text" class="fit" placeholder="0x... or leave blank">
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Simple footer -->
      <footer id="footer">
        <ul class="icons">
          <li><a href="https://twitter.com/YourUsername" target="_blank" rel="noopener noreferrer" class="icon brands alt fa-twitter"><span class="label">Twitter</span></a></li>
          <li><a href="https://github.com/YourUsername" target="_blank" rel="noopener noreferrer" class="icon brands alt fa-github"><span class="label">GitHub</span></a></li>
          <li><a href="mailto:your.email@example.com" class="icon solid alt fa-envelope"><span class="label">Email</span></a></li>
        </ul>
      </footer>
    </div>

    <!-- JS (same bundle as homepage so styles/behavior match) -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/jquery.dropotron.min.js"></script>
    <script src="assets/js/jquery.scrollex.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Minimal MetaMask flow (no account dropdown dependencies) -->
    <script>
      const btnConnect = document.getElementById("btnConnect");
      const btnInvest  = document.getElementById("btnInvest");
      const statusEl   = document.getElementById("investStatus");
      const amountEl   = document.getElementById("amountMatic");
      const contractEl = document.getElementById("contractAddress");
      const referralEl = document.getElementById("referralAddr");

      let currentAccount = null;

      const setStatus = (msg) => statusEl.textContent = "Status: " + msg;

      function parseEtherToHexWei(amountStr) {
        if (!amountStr) throw new Error("Invalid amount");
        const [wholeRaw, fracRaw = ""] = amountStr.split(".");
        const whole = wholeRaw === "" ? "0" : wholeRaw;
        const frac  = (fracRaw + "0".repeat(18)).slice(0, 18);
        const wei   = BigInt(whole) * (10n ** 18n) + BigInt(frac);
        return "0x" + wei.toString(16);
      }

      btnConnect.addEventListener("click", async (e) => {
        e.preventDefault();
        if (typeof window.ethereum === "undefined") {
          setStatus("MetaMask not detected. Install from metamask.io");
          return;
        }
        try {
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          currentAccount = accounts[0] || null;
          const chainId = await window.ethereum.request({ method: "eth_chainId" });
          setStatus(currentAccount ? ("Connected: " + currentAccount) : "No account");
        } catch (err) {
          setStatus("Error: " + (err.message || err));
        }
      });

      btnInvest.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!currentAccount) { setStatus("Please connect wallet first."); return; }
        if (typeof window.ethereum === "undefined") { setStatus("Wallet not found."); return; }

        const amountStr = (amountEl.value || "").trim();
        const to        = (contractEl.value || "").trim();

        if (!amountStr || isNaN(amountStr)) { setStatus("Enter a valid amount."); return; }
        if (!/^0x[a-fA-F0-9]{40}$/.test(to)) { setStatus("Invalid contract address."); return; }

        let valueHex;
        try { valueHex = parseEtherToHexWei(amountStr); }
        catch (err) { setStatus("Amount error: " + err.message); return; }

        setStatus("Sending transaction… check MetaMask");
        try {
          const txHash = await window.ethereum.request({
            method: "eth_sendTransaction",
            params: [{ from: currentAccount, to, value: valueHex }],
          });
          setStatus("Transaction sent! Hash: " + txHash);
        } catch (err) {
          setStatus("Transaction failed: " + (err.message || err));
        }
      });

      // Mobile helper: deep link to wallet if no provider detected
      (function mobileWalletHelper() {
        const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const actions = document.querySelector("#investForm .actions");
        const walletSelect = document.getElementById("walletSelect");
        if (!isMobile || !actions) return;

        if (typeof window.ethereum === "undefined") {
          const li = document.createElement("li");
          const a  = document.createElement("a");
          a.className = "button";
          a.textContent = "Open in Wallet App";
          a.href = "#";
          a.addEventListener("click", (e) => {
            e.preventDefault();
            const choice = walletSelect?.value || "metamask";
            const cleanUrl = location.href.replace(/^https?:\/\//, "");
            if (choice === "metamask") {
              window.location.href = `https://metamask.app.link/dapp/${cleanUrl}`;
            } else if (choice === "trust") {
              window.location.href = `trust://open_url?url=${encodeURIComponent(location.href)}`;
            } else {
              alert("Select a wallet first.");
            }
          });
          li.appendChild(a);
          actions.appendChild(li);
          setStatus("Mobile browser detected without wallet provider. Use the 'Open in Wallet App' button.");
        }
      })();

      // Make amount robust to commas on some mobile keyboards
      (function patchAmountComma(){
        const amt = document.getElementById("amountMatic");
        if (!amt) return;
        amt.addEventListener("input", () => {
          if (amt.value.includes(",")) amt.value = amt.value.replace(",", ".");
        });
      })();
    </script>
  </body>
</html>
